#!/usr/bin/env bash
#
# wp-malware-scan.sh
#
# WordPress malware scanner wrapper for:
#   - Maldet (Linux Malware Detect)
#   - ClamAV (clamscan)
#
# - Auto-detects WordPress installs under /home/*/public_html
# - Lets you scan one site or ALL sites
# - Logs results under /var/log/wp-malware-scan/
#
# Run (as root) directly from GitHub:
#   bash <(curl -fsSL https://raw.githubusercontent.com/lunaweb89/wp-maintenance-tools/main/wp-malware-scan.sh)
#

set -uo pipefail

COLOR_RED="$(tput setaf 1 2>/dev/null || echo "")"
COLOR_GREEN="$(tput setaf 2 2>/dev/null || echo "")"
COLOR_YELLOW="$(tput setaf 3 2>/dev/null || echo "")"
COLOR_BLUE="$(tput setaf 4 2>/dev/null || echo "")"
COLOR_RESET="$(tput sgr0 2>/dev/null || echo "")"

log() {
  echo -e "${COLOR_BLUE}[+]${COLOR_RESET} $*"
}

warn() {
  echo -e "${COLOR_YELLOW}[-]${COLOR_RESET} $*"
}

err() {
  echo -e "${COLOR_RED}[!] $*${COLOR_RESET}" >&2
}

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    err "This script must be run as root (sudo)."
    exit 1
  fi
}

check_tools() {
  local missing=0

  if ! command -v maldet &>/dev/null; then
    err "Required binary 'maldet' not found."
    echo "    Please install Linux Malware Detect first."
    echo "    (On this server you can also run your secure-server setup script.)"
    missing=1
  fi

  if ! command -v clamscan &>/dev/null; then
    warn "ClamAV (clamscan) not found. Maldet scans will still run, but ClamAV will be skipped."
  fi

  if (( missing == 1 )); then
    err "Maldet missing; aborting."
    exit 1
  fi
}

discover_wp_installs() {
  WP_INSTALLS=()
  while IFS= read -r cfg; do
    WP_INSTALLS+=("$(dirname "$cfg")")
  done < <(find /home -maxdepth 3 -type f -name "wp-config.php" 2>/dev/null | sort)

  if ((${#WP_INSTALLS[@]} == 0)); then
    err "No WordPress installations found under /home."
    exit 1
  fi

  log "Looking for WordPress installations under /home..."
  echo "[+] Found ${#WP_INSTALLS[@]} WordPress install(s):"
  local path parent domain
  for path in "${WP_INSTALLS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    echo "    - ${domain} (${path})"
  done
}

select_scope() {
  echo
  echo "Scan options:"
  echo "  [1] Scan a single site"
  echo "  [2] Scan ALL sites"
  echo

  local choice
  while :; do
    read -rp "Select option [1-2]: " choice
    case "$choice" in
      1)
        SCOPE="single"
        break
        ;;
      2)
        SCOPE="all"
        break
        ;;
      *)
        warn "Please enter 1 or 2."
        ;;
    esac
  done

  if [[ "$SCOPE" == "single" ]]; then
    echo
    echo "Available sites:"
    local i=1 path parent domain
    for path in "${WP_INSTALLS[@]}"; do
      parent="$(dirname "$path")"
      domain="$(basename "$parent")"
      echo "  [$i] ${domain} (${path})"
      ((i++))
    done
    echo
    local idx
    while :; do
      read -rp "Select site number to scan: " idx
      [[ "$idx" =~ ^[0-9]+$ ]] || { warn "Please enter a number."; continue; }
      if (( idx < 1 || idx > ${#WP_INSTALLS[@]} )); then
        warn "Invalid choice. Must be 1–${#WP_INSTALLS[@]}."
        continue
      fi
      break
    done
    TARGETS=("${WP_INSTALLS[idx-1]}")
  else
    TARGETS=("${WP_INSTALLS[@]}")
  fi
}

run_scans() {
  LOG_DIR="/var/log/wp-malware-scan"
  mkdir -p "$LOG_DIR"

  # Global timestamp for this run (used later in summary)
  TS="$(date +%Y%m%d-%H%M%S)"

  for WP_PATH in "${TARGETS[@]}"; do
    local parent domain
    parent="$(dirname "$WP_PATH")"
    domain="$(basename "$parent")"

    echo
    log "Scanning site: ${domain}"
    echo "    Path       : ${WP_PATH}"
    echo "    Log prefix : ${LOG_DIR}/${domain}-${TS}-*"

    # ---- Maldet ----
    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    log "Running Maldet scan on ${WP_PATH}..."
    if maldet -a "$WP_PATH" &> "$maldet_log"; then
      log "Maldet scan finished. Log: ${maldet_log}"
    else
      warn "Maldet scan had errors. See log: ${maldet_log}"
    fi

    # ---- ClamAV ----
    if command -v clamscan &>/dev/null; then
      local clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"
      log "Running ClamAV (clamscan) on ${WP_PATH}..."
      if clamscan -ri "$WP_PATH" &> "$clam_log"; then
        log "ClamAV scan finished. Log: ${clam_log}"
      else
        # clamscan returns non-zero if infections found; that's not necessarily fatal
        warn "ClamAV reported issues or infections. Check log: ${clam_log}"
      fi
    fi
  done

  echo
  log "All requested scans have completed."
  log "Logs stored under: /var/log/wp-malware-scan/"
}

summarize_results() {
  local LOG_DIR="/var/log/wp-malware-scan"

  echo
  echo "=================== Scan Summary ==================="

  for WP_PATH in "${TARGETS[@]}"; do
    local parent domain
    parent="$(dirname "$WP_PATH")"
    domain="$(basename "$parent")"

    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    local clamav_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

    local maldet_hits clamav_infected
    maldet_hits=0
    clamav_infected=0

    if [[ -f "$maldet_log" ]]; then
      maldet_hits="$(grep -Eo 'malware hits [0-9]+' "$maldet_log" 2>/dev/null | awk '{print $3}' | tail -n1)"
      [[ -z "$maldet_hits" ]] && maldet_hits=0
    fi

    if [[ -f "$clamav_log" ]]; then
      clamav_infected="$(grep -E 'Infected files:' "$clamav_log" 2>/dev/null | awk '{print $3}' | tail -n1)"
      [[ -z "$clamav_infected" ]] && clamav_infected=0
    fi

    local status color
    if [[ "$maldet_hits" != "0" || "$clamav_infected" != "0" ]]; then
      status="INFECTED"
      color="$COLOR_RED"
    else
      status="CLEAN"
      color="$COLOR_GREEN"
    fi

    echo
    echo -e "→ ${domain} : ${color}${status}${COLOR_RESET} (Maldet: ${maldet_hits}, ClamAV: ${clamav_infected})"

    # ---- If infected, print detailed file list so user can paste into ChatGPT ----

    if [[ "$clamav_infected" != "0" && -f "$clamav_log" ]]; then
      echo "  [ClamAV detected files]"
      # Lines ending with FOUND give us path + signature
      if ! grep -E "FOUND$" "$clamav_log" 2>/dev/null | sed 's/^/    /'; then
        echo "    (No detailed ClamAV paths found in log.)"
      fi
    fi

    if [[ "$maldet_hits" != "0" && -f "$maldet_log" ]]; then
      echo "  [Maldet detected files]"
      # Look for lines that typically mark hits
      if ! grep -Ei "FILE HIT|{HIT}|MALWARE|INFECTED" "$maldet_log" 2>/dev/null | sed 's/^/    /'; then
        echo "    (No detailed Maldet paths found in log.)"
      fi
    fi
  done

  echo
  echo "====================================================="
  echo
  echo "If any site is marked INFECTED, copy the [ClamAV/Maldet detected files]"
  echo "section and paste into ChatGPT for cleanup guidance."
}

main() {
  require_root
  check_tools
  discover_wp_installs
  select_scope
  run_scans
  summarize_results
}

main "$@"

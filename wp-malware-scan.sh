#!/usr/bin/env bash
#
# wp-malware-scan.sh
#
# WordPress malware scanner wrapper for:
#   - Maldet (Linux Malware Detect)
#   - ClamAV (clamscan)
#
# - Auto-detects WordPress installs under /home/*/public_html
# - Lets you select ANY subset of sites (1 2 5, or A for all)
# - Logs results under /var/log/wp-malware-scan/
# - Prints a summary and lists detected files if INFECTED
# - Optional quarantine helper to move suspicious files
#

set -euo pipefail

COLOR_RED="$(tput setaf 1 2>/dev/null || echo "")"
COLOR_GREEN="$(tput setaf 2 2>/dev/null || echo "")"
COLOR_YELLOW="$(tput setaf 3 2>/dev/null || echo "")"
COLOR_BLUE="$(tput setaf 4 2>/dev/null || echo "")"
COLOR_RESET="$(tput sgr0 2>/dev/null || echo "")"

log()  { echo -e "${COLOR_BLUE}[+]${COLOR_RESET} $*"; }
warn() { echo -e "${COLOR_YELLOW}[-]${COLOR_RESET} $*"; }
err()  { echo -e "${COLOR_RED}[!] $*${COLOR_RESET}" >&2; }

# ---- Parsing helpers (NEW) ----

# Parse "malware hits N" from a Maldet log
parse_maldet_hits() {
  local log="$1"
  if [[ ! -f "$log" ]]; then
    echo 0
    return
  fi

  grep "scan completed on" "$log" 2>/dev/null \
    | awk -F'malware hits ' '{print $2}' \
    | awk -F',' '{print $1}' \
    | tr -dc '0-9' \
    | { read n || true; echo "${n:-0}"; }
}

# Parse "Infected files: N" from a ClamAV log
parse_clamav_hits() {
  local log="$1"
  if [[ ! -f "$log" ]]; then
    echo 0
    return
  fi

  grep -m1 "Infected files:" "$log" 2>/dev/null \
    | awk -F':' '{print $2}' \
    | tr -dc '0-9' \
    | { read n || true; echo "${n:-0}"; }
}

check_tools() {
  local missing=0

  if ! command -v maldet &>/dev/null; then
    err "Required binary 'maldet' not found."
    echo "    Please install Linux Malware Detect first."
    missing=1
  fi

  if ! command -v clamscan &>/dev/null; then
    warn "ClamAV (clamscan) not found. Maldet scans will still run, but ClamAV will be skipped."
  fi

  if (( missing == 1 )); then
    err "Maldet missing; aborting."
    exit 1
  fi
}

discover_wp_installs() {
  WP_INSTALLS=()
  while IFS= read -r cfg; do
    WP_INSTALLS+=("$(dirname "$cfg")")
  done < <(find /home -maxdepth 3 -type f -name "wp-config.php" 2>/dev/null | sort)

  if ((${#WP_INSTALLS[@]} == 0)); then
    err "No WordPress installations found under /home."
    exit 1
  fi

  log "Looking for WordPress installations under /home..."
  echo "[+] Found ${#WP_INSTALLS[@]} WordPress install(s):"

  local path parent domain size i=1
  for path in "${WP_INSTALLS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    # Detect size of each WP install
    size=$(du -sh "$path" 2>/dev/null | awk '{print $1}')
    echo "  [$i] ${domain} (Path: ${path}, Size: ${size:-N/A})"
    ((i++))
  done
}

select_sites() {
  echo
  read -rp "Scan which sites? (e.g. 1 2 5, or A for all): " selection

  TARGETS=()
  if [[ "$selection" =~ ^[Aa]$ ]]; then
    TARGETS=("${WP_INSTALLS[@]}")
  else
    for token in $selection; do
      if ! [[ "$token" =~ ^[0-9]+$ ]]; then
        warn "Ignoring invalid token '$token' (not a number)."
        continue
      fi
      if (( token < 1 || token > ${#WP_INSTALLS[@]} )); then
        warn "Ignoring out-of-range index '$token'."
        continue
      fi
      TARGETS+=("${WP_INSTALLS[token-1]}")
    done
    if ((${#TARGETS[@]} == 0)); then
      err "No valid sites selected; nothing to scan."
      exit 1
    fi
  fi

  echo
  log "You selected ${#TARGETS[@]} site(s) to scan:"
  local path parent domain size
  for path in "${TARGETS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    size=$(du -sh "$path" 2>/dev/null | awk '{print $1}')
    echo "  - ${domain} (Path: ${path}, Size: ${size:-N/A})"
  done

  echo
  read -rp "Proceed with malware scan on these site(s)? (y/N): " ok
  [[ "$ok" =~ ^[Yy]$ ]] || { warn "Cancelled."; exit 0; }
}

run_scans() {
  local LOG_DIR="/var/log/wp-malware-scan"
  mkdir -p "$LOG_DIR"

  TS="$(date +%Y%m%d-%H%M%S)"
  DOMAIN_LIST=()

  for WP_PATH in "${TARGETS[@]}"; do
    local parent domain
    parent="$(dirname "$WP_PATH")"
    domain="$(basename "$parent")"
    DOMAIN_LIST+=("$domain")

    echo
    log "Scanning site: ${domain}"
    echo "    Path       : ${WP_PATH}"
    echo "    Log prefix : ${LOG_DIR}/${domain}-${TS}-*"

    # ---- Maldet ----
    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    log "Running Maldet scan on ${WP_PATH}..."

    # capture exit code correctly even with set -e
    local MALDET_EXIT
    if maldet -a "$WP_PATH" &> "$maldet_log"; then
      MALDET_EXIT=0
    else
      MALDET_EXIT=$?
    fi

    if [[ $MALDET_EXIT -eq 0 ]]; then
      log "Maldet scan finished (exit 0). Log: ${maldet_log}"
    elif [[ $MALDET_EXIT -eq 1 ]]; then
      log "Maldet scan finished and reported malware (exit 1). Log: ${maldet_log}"
    else
      warn "Maldet scan error (exit ${MALDET_EXIT}). See log: ${maldet_log}"
    fi

    # ---- ClamAV ----
    if command -v clamscan &>/dev/null; then
      local clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"
      log "Running ClamAV (clamscan) on ${WP_PATH}..."
      if clamscan -ri "$WP_PATH" &> "$clam_log"; then
        log "ClamAV scan finished (no infected files). Log: ${clam_log}"
      else
        # exit 1 = infected; >1 = error. We treat both as "reported issues".
        warn "ClamAV reported issues or infections (exit $?). Check log: ${clam_log}"
      fi
    fi

    log "Completed scans for ${domain}."
  done

  echo
  log "Malware scans completed for ${#DOMAIN_LIST[@]} site(s)."
  log "Logs are stored in: ${LOG_DIR}"

  # Show summary + offer quarantine
  print_summary
}

print_summary() {
  local LOG_DIR="/var/log/wp-malware-scan"
  local any_infected=0

  echo
  echo "=================== Scan Summary ==================="

  for domain in "${DOMAIN_LIST[@]}"; do
    local maldet_log clam_log
    maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

    local mal_hits="N/A"
    local clam_inf="N/A"

    if [[ -f "$maldet_log" ]]; then
      mal_hits="$(parse_maldet_hits "$maldet_log")"
    fi
    if [[ -f "$clam_log" ]]; then
      clam_inf="$(parse_clamav_hits "$clam_log")"
    fi

    local status
    if [[ "$mal_hits" =~ ^[0-9]+$ && "$clam_inf" =~ ^[0-9]+$ ]]; then
      if (( mal_hits == 0 && clam_inf == 0 )); then
        status="CLEAN"
      else
        status="INFECTED"
        any_infected=1
      fi
    else
      status="UNKNOWN"
    fi

    echo
    echo "→ ${domain} : ${status} (Maldet: ${mal_hits}, ClamAV: ${clam_inf})"
  done

  echo
  echo "===================================================="

  if (( any_infected == 1 )); then
    echo
    echo "[ClamAV/Maldet detected files] (truncated to first 50 lines per engine)"
    echo

    for domain in "${DOMAIN_LIST[@]}"; do
      local maldet_log clam_log
      maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
      clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

      echo "----- ${domain} -----"

      if [[ -f "$maldet_log" ]]; then
        echo "Maldet suspicious:"
        # Show interesting lines; this is mostly for context.
        grep -Ei 'malware hits|trojan|php\..*FOUND|INFECTED' "$maldet_log" | head -n 50 || true
      else
        echo "Maldet log not found."
      fi

      echo

      if [[ -f "$clam_log" ]]; then
        echo "ClamAV suspicious:"
        grep -Ei 'FOUND|INFECTED' "$clam_log" | head -n 50 || true
      else
        echo "ClamAV log not found."
      fi

      echo
    done

    echo "If any site is marked INFECTED, review the above files carefully."

    echo
    read -rp "Run malware QUARANTINE helper now? (y/N): " do_quar
    if [[ "$do_quar" =~ ^[Yy]$ ]]; then
      malware_quarantine_helper
    else
      warn "Skipping quarantine helper. No files were moved."
    fi
  else
    log "All scanned sites appear CLEAN based on Maldet/ClamAV summaries."
  fi
}

malware_quarantine_helper() {
  local LOG_DIR="/var/log/wp-malware-scan"
  local QUAR_ROOT="/var/quarantine/wp-malware-$(date +%Y%m%d-%H%M%S)"
  mkdir -p "$QUAR_ROOT"

  log "Quarantine directory: $QUAR_ROOT"

  local tmpfile
  tmpfile="$(mktemp)"

  # Collect suspicious file paths from logs
  for domain in "${DOMAIN_LIST[@]}"; do
    local maldet_log clam_log
    maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

    # From ClamAV: lines like "/path/to/file: ThreatName FOUND"
    if [[ -f "$clam_log" ]]; then
      grep -Ei 'FOUND|INFECTED' "$clam_log" | awk -F':' '{print $1}' >>"$tmpfile" || true
    fi

    # From Maldet: lines with malware/trojan/INFECTED etc – last field often a path (best-effort)
    if [[ -f "$maldet_log" ]]; then
      grep -Ei 'malware|trojan|php\..*FOUND|INFECTED' "$maldet_log" | awk '{print $NF}' >>"$tmpfile" || true
    fi
  done

  mapfile -t FILES_TO_REVIEW < <(sort -u "$tmpfile" | sed '/^$/d')
  rm -f "$tmpfile"

  if ((${#FILES_TO_REVIEW[@]} == 0)); then
    warn "No suspicious file paths parsed from logs. Nothing to quarantine."
    return
  fi

  echo
  log "Found ${#FILES_TO_REVIEW[@]} suspicious file path(s) in logs."

  for f in "${FILES_TO_REVIEW[@]}"; do
    if [[ ! -f "$f" ]]; then
      warn "Skipping (not a regular file anymore): $f"
      continue
    fi

    echo
    echo "Suspicious file: $f"
    read -rp "Quarantine this file (move to $QUAR_ROOT)? [y/N]: " ans
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      local target="$QUAR_ROOT$f"
      mkdir -p "$(dirname "$target")"
      if mv "$f" "$target"; then
        log "Quarantined: $f → $target"
      else
        err "Failed to move $f"
      fi
    else
      warn "Left in place: $f"
    fi
  done

  echo
  log "Quarantine helper finished. Quarantined files are under: $QUAR_ROOT"
}

main() {
  check_tools
  discover_wp_installs
  select_sites
  run_scans
}

main "$@"

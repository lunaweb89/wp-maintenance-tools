#!/usr/bin/env bash
#
# wp-malware-scan.sh
#
# WordPress malware scanner wrapper for:
#   - Maldet (Linux Malware Detect)
#   - ClamAV (clamscan)
#
# - Auto-detects WordPress installs under /home/*/public_html
# - Lets you select ANY subset of sites (1 2 5, or A for all)
# - Logs results under /var/log/wp-malware-scan/
# - Prints a summary and lists detected files if INFECTED
#

set -euo pipefail

COLOR_RED="$(tput setaf 1 2>/dev/null || echo "")"
COLOR_GREEN="$(tput setaf 2 2>/dev/null || echo "")"
COLOR_YELLOW="$(tput setaf 3 2>/dev/null || echo "")"
COLOR_BLUE="$(tput setaf 4 2>/dev/null || echo "")"
COLOR_RESET="$(tput sgr0 2>/dev/null || echo "")"

log()  { echo -e "${COLOR_BLUE}[+]${COLOR_RESET} $*"; }
warn() { echo -e "${COLOR_YELLOW}[-]${COLOR_RESET} $*"; }
err()  { echo -e "${COLOR_RED}[!] $*${COLOR_RESET}" >&2; }

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    err "This script must be run as root (sudo)."
    exit 1
  fi
}

check_tools() {
  local missing=0

  if ! command -v maldet &>/dev/null; then
    err "Required binary 'maldet' not found."
    echo "    Please install Linux Malware Detect first."
    missing=1
  fi

  if ! command -v clamscan &>/dev/null; then
    warn "ClamAV (clamscan) not found. Maldet scans will still run, but ClamAV will be skipped."
  fi

  if (( missing == 1 )); then
    err "Maldet missing; aborting."
    exit 1
  fi
}

discover_wp_installs() {
  WP_INSTALLS=()
  while IFS= read -r cfg; do
    WP_INSTALLS+=("$(dirname "$cfg")")
  done < <(find /home -maxdepth 3 -type f -name "wp-config.php" 2>/dev/null | sort)

  if ((${#WP_INSTALLS[@]} == 0)); then
    err "No WordPress installations found under /home."
    exit 1
  fi

  log "Looking for WordPress installations under /home..."
  echo "[+] Found ${#WP_INSTALLS[@]} WordPress install(s):"
  local path parent domain i=1
  for path in "${WP_INSTALLS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    echo "  [$i] ${domain} (${path})"
    ((i++))
  done
}

select_sites() {
  echo
  read -rp "Scan which sites? (e.g. 1 2 5, or A for all): " selection

  TARGETS=()
  if [[ "$selection" =~ ^[Aa]$ ]]; then
    TARGETS=("${WP_INSTALLS[@]}")
  else
    for token in $selection; do
      if ! [[ "$token" =~ ^[0-9]+$ ]]; then
        warn "Ignoring invalid token '$token' (not a number)."
        continue
      fi
      if (( token < 1 || token > ${#WP_INSTALLS[@]} )); then
        warn "Ignoring out-of-range index '$token'."
        continue
      fi
      TARGETS+=("${WP_INSTALLS[token-1]}")
    done
    if ((${#TARGETS[@]} == 0)); then
      err "No valid sites selected; nothing to scan."
      exit 1
    fi
  fi

  echo
  log "You selected ${#TARGETS[@]} site(s) to scan:"
  local path parent domain
  for path in "${TARGETS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    echo "  - ${domain} (${path})"
  done

  echo
  read -rp "Proceed with malware scan on these site(s)? (y/N): " ok
  [[ "$ok" =~ ^[Yy]$ ]] || { warn "Cancelled."; exit 0; }
}

run_scans() {
  local LOG_DIR="/var/log/wp-malware-scan"
  mkdir -p "$LOG_DIR"

  TS="$(date +%Y%m%d-%H%M%S)"

  DOMAIN_LIST=()

  for WP_PATH in "${TARGETS[@]}"; do
    local parent domain
    parent="$(dirname "$WP_PATH")"
    domain="$(basename "$parent")"
    DOMAIN_LIST+=("$domain")

    echo
    log "Scanning site: ${domain}"
    echo "    Path       : ${WP_PATH}"
    echo "    Log prefix : ${LOG_DIR}/${domain}-${TS}-*"

    # ---- Maldet ----
    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    log "Running Maldet scan on ${WP_PATH}..."
    if maldet -a "$WP_PATH" &> "$maldet_log"; then
      log "Maldet scan finished. Log: ${maldet_log}"
    else
      warn "Maldet scan had errors. See log: ${maldet_log}"
    fi

    # ---- ClamAV ----
    if command -v clamscan &>/dev/null; then
      local clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"
      log "Running ClamAV (clamscan) on ${WP_PATH}..."
      if clamscan -ri "$WP_PATH" &> "$clam_log"; then
        log "ClamAV scan finished. Log: ${clam_log}"
      else
        warn "ClamAV reported issues or infections. Check log: ${clam_log}"
      fi
    fi
  done
}

print_summary() {
  local LOG_DIR="/var/log/wp-malware-scan"

  echo
  echo "=================== Scan Summary ==================="

  local infected_any=0

  for domain in "${DOMAIN_LIST[@]}"; do
    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    local clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

    local mal_hits=0 clam_hits=0

    if [[ -f "$maldet_log" ]]; then
      mal_hits="$(grep -Ei 'malware hits' "$maldet_log" 2>/dev/null | awk '{print $6}' | tr -d ',' || echo 0)"
      [[ -z "$mal_hits" ]] && mal_hits=0
    fi

    if [[ -f "$clam_log" ]]; then
      clam_hits="$(grep -E '^Infected files:' "$clam_log" 2>/dev/null | awk '{print $3}' || echo 0)"
      [[ -z "$clam_hits" ]] && clam_hits=0
    fi

    if (( mal_hits > 0 || clam_hits > 0 )); then
      infected_any=1
      echo
      echo -e "→ ${domain} : ${COLOR_RED}INFECTED${COLOR_RESET} (Maldet: ${mal_hits}, ClamAV: ${clam_hits})"
    else
      echo
      echo -e "→ ${domain} : ${COLOR_GREEN}CLEAN${COLOR_RESET} (Maldet: ${mal_hits}, ClamAV: ${clam_hits})"
    fi
  done

  if (( infected_any == 0 )); then
    echo
    echo "====================================================="
    echo "All scanned sites are CLEAN."
    echo "====================================================="
    return
  fi

  echo
  echo "====================================================="
  echo " [ClamAV/Maldet detected files]"
  echo "====================================================="

  for domain in "${DOMAIN_LIST[@]}"; do
    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    local clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

    local mal_hits=0 clam_hits=0
    [[ -f "$maldet_log" ]] && mal_hits="$(grep -Ei 'malware hits' "$maldet_log" 2>/dev/null | awk '{print $6}' | tr -d ',' || echo 0)"
    [[ -f "$clam_log" ]] && clam_hits="$(grep -E '^Infected files:' "$clam_log" 2>/dev/null | awk '{print $3}' || echo 0)"

    if (( mal_hits == 0 && clam_hits == 0 )); then
      continue
    fi

    echo
    echo "Domain: ${domain}"

    if (( mal_hits > 0 )) && [[ -f "$maldet_log" ]]; then
      echo "  Maldet:"
      grep -E '^\s*/.*' "$maldet_log" 2>/dev/null | head -n 50 || echo "    (See full log: $maldet_log)"
    fi

    if (( clam_hits > 0 )) && [[ -f "$clam_log" ]]; then
      echo "  ClamAV:"
      grep ' FOUND$' "$clam_log" 2>/dev/null | head -n 50 || echo "    (See full log: $clam_log)"
    fi
  done

  echo
  echo "If any site is marked INFECTED, copy the [ClamAV/Maldet detected files]"
  echo "section and paste into ChatGPT for cleanup guidance."
}

main() {
  require_root
  check_tools
  discover_wp_installs
  select_sites
  run_scans
  print_summary
}

main "$@"

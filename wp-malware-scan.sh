#!/usr/bin/env bash
#
# wp-malware-scan.sh
#
# WordPress malware scanner wrapper for:
#   - Maldet (Linux Malware Detect)
#   - ClamAV (clamscan)
#
# - Auto-detects WordPress installs under /home/*/public_html
# - Lets you scan selected site(s) or ALL sites
# - Logs results under /var/log/wp-malware-scan/
# - Prints summary + suspicious lines if infections are found
#

set -euo pipefail

COLOR_RED="$(tput setaf 1 2>/dev/null || echo "")"
COLOR_GREEN="$(tput setaf 2 2>/dev/null || echo "")"
COLOR_YELLOW="$(tput setaf 3 2>/dev/null || echo "")"
COLOR_BLUE="$(tput setaf 4 2>/dev/null || echo "")"
COLOR_RESET="$(tput sgr0 2>/dev/null || echo "")"

log()  { echo -e "${COLOR_BLUE}[+]${COLOR_RESET} $*"; }
warn() { echo -e "${COLOR_YELLOW}[-]${COLOR_RESET} $*"; }
err()  { echo -e "${COLOR_RED}[!] $*${COLOR_RESET}" >&2; }

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    err "This script must be run as root."
    echo "Use the toolkit launcher instead:"
    echo "  curl -fsSL https://raw.githubusercontent.com/lunaweb89/wp-maintenance-tools/main/wp-toolkit.sh \\"
    echo "    | ( command -v sudo >/dev/null 2>&1 && sudo bash || bash )"
    exit 1
  fi
}

check_tools() {
  local missing=0

  if ! command -v maldet &>/dev/null; then
    err "Required binary 'maldet' not found."
    echo "  Install Linux Malware Detect first."
    missing=1
  fi

  if ! command -v clamscan &>/dev/null; then
    warn "ClamAV (clamscan) not found. Maldet scans will still run, but ClamAV will be skipped."
  fi

  if (( missing == 1 )); then
    err "Maldet missing; aborting."
    exit 1
  fi
}

discover_wp_installs() {
  WP_INSTALLS=()
  while IFS= read -r cfg; do
    WP_INSTALLS+=("$(dirname "$cfg")")
  done < <(find /home -maxdepth 3 -type f -name "wp-config.php" 2>/dev/null | sort)

  if ((${#WP_INSTALLS[@]} == 0)); then
    err "No WordPress installations found under /home."
    exit 1
  fi

  log "Looking for WordPress installations under /home..."
  echo "[+] Found ${#WP_INSTALLS[@]} WordPress install(s):"
  local path parent domain
  for path in "${WP_INSTALLS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    echo "    - ${domain} (${path})"
  done
}

select_sites() {
  echo
  echo "Scan options:"
  echo "  A) All sites"
  echo "  Or enter numbers: e.g. 1 2 5"
  echo

  echo "Available sites:"
  local i=1 path parent domain
  for path in "${WP_INSTALLS[@]}"; do
    parent="$(dirname "$path")"
    domain="$(basename "$parent")"
    echo "  [$i] ${domain} (${path})"
    ((i++))
  done
  echo

  local selection
  read -rp "Scan which sites? (e.g. 1 2 5, or A for all): " selection

  TARGETS=()

  if [[ "$selection" =~ ^[Aa]$ ]]; then
    TARGETS=("${WP_INSTALLS[@]}")
  else
    for token in $selection; do
      if ! [[ "$token" =~ ^[0-9]+$ ]]; then
        warn "Ignoring invalid token '$token' (not a number)."
        continue
      fi
      if (( token < 1 || token > ${#WP_INSTALLS[@]} )); then
        warn "Ignoring out-of-range index '$token'."
        continue
      fi
      TARGETS+=("${WP_INSTALLS[token-1]}")
    done
    if [[ ${#TARGETS[@]} -eq 0 ]]; then
      err "No valid sites selected; nothing to scan."
      exit 1
    fi
  fi

  echo
  log "You selected ${#TARGETS[@]} site(s) to scan:"
  for wp in "${TARGETS[@]}"; do
    local parent domain
    parent="$(dirname "$wp")"
    domain="$(basename "$parent")"
    echo "  - $domain ($wp)"
  done

  echo
  read -rp "Proceed with scan of these site(s)? (y/N): " CONFIRM
  [[ "$CONFIRM" =~ ^[Yy]$ ]] || { warn "Scan cancelled."; exit 0; }
}

run_scans() {
  local LOG_DIR="/var/log/wp-malware-scan"
  mkdir -p "$LOG_DIR"

  TS="$(date +%Y%m%d-%H%M%S)"
  DOMAIN_LIST=()

  for WP_PATH in "${TARGETS[@]}"; do
    local parent domain
    parent="$(dirname "$WP_PATH")"
    domain="$(basename "$parent")"
    DOMAIN_LIST+=("$domain")

    echo
    log "Scanning site: ${domain}"
    echo "    Path       : ${WP_PATH}"
    echo "    Log prefix : ${LOG_DIR}/${domain}-${TS}-*"

    # ---- Maldet ----
    local maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    log "Running Maldet scan on ${WP_PATH}..."
    if maldet -a "$WP_PATH" &> "$maldet_log"; then
      log "Maldet scan finished. Log: ${maldet_log}"
    else
      warn "Maldet scan had errors. See log: ${maldet_log}"
    fi

    # ---- ClamAV ----
    if command -v clamscan &>/dev/null; then
      local clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"
      log "Running ClamAV (clamscan) on ${WP_PATH}..."
      if clamscan -ri "$WP_PATH" &> "$clam_log"; then
        log "ClamAV scan finished. Log: ${clam_log}"
      else
        # clamscan returns non-zero if infections found; that's not fatal
        warn "ClamAV reported issues or infections. Check log: ${clam_log}"
      fi
    fi
  done

  echo
  log "All requested scans have completed."
  log "Logs stored under: /var/log/wp-malware-scan/"
}

print_summary() {
  local LOG_DIR="/var/log/wp-malware-scan"
  local any_infected=0

  echo
  echo "=================== Scan Summary ==================="

  for domain in "${DOMAIN_LIST[@]}"; do
    local maldet_log clam_log
    maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
    clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

    local mal_hits="N/A"
    local clam_inf="N/A"

    if [[ -f "$maldet_log" ]]; then
      mal_hits="$(grep -E 'malware hits' "$maldet_log" | awk '{print $NF}' || echo "N/A")"
    fi
    if [[ -f "$clam_log" ]]; then
      clam_inf="$(grep -E 'Infected files' "$clam_log" | awk -F': ' '{print $2}' || echo "N/A")"
    fi

    local status
    if [[ "$mal_hits" =~ ^[0-9]+$ && "$clam_inf" =~ ^[0-9]+$ ]]; then
      if (( mal_hits == 0 && clam_inf == 0 )); then
        status="CLEAN"
      else
        status="INFECTED"
        any_infected=1
      fi
    else
      status="UNKNOWN"
    fi

    echo
    echo "â†’ ${domain} : ${status} (Maldet: ${mal_hits}, ClamAV: ${clam_inf})"
  done

  echo
  echo "===================================================="

  if (( any_infected == 1 )); then
    echo
    echo "[ClamAV/Maldet detected files] (truncated to first 50 lines per engine)"
    echo

    for domain in "${DOMAIN_LIST[@]}"; do
      local maldet_log clam_log
      maldet_log="${LOG_DIR}/${domain}-${TS}-maldet.log"
      clam_log="${LOG_DIR}/${domain}-${TS}-clamav.log"

      echo "----- ${domain} -----"

      if [[ -f "$maldet_log" ]]; then
        echo "Maldet suspicious:"
        grep -Ei 'malware|trojan|php\..*FOUND|INFECTED' "$maldet_log" | head -n 50 || true
      else
        echo "Maldet log not found."
      fi

      echo

      if [[ -f "$clam_log" ]]; then
        echo "ClamAV suspicious:"
        grep -Ei 'FOUND|INFECTED' "$clam_log" | head -n 50 || true
      else
        echo "ClamAV log not found."
      fi

      echo
    done

    echo "If any site is marked INFECTED, copy the [ClamAV/Maldet detected files]"
    echo "section and paste into ChatGPT for cleanup guidance."
  fi
}

main() {
  require_root
  check_tools
  discover_wp_installs
  select_sites
  run_scans
  print_summary
}

main "$@"

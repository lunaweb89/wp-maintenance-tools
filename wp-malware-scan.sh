#!/usr/bin/env bash
#
# wp-malware-scan.sh
#
# Simple WordPress malware scanning helper:
#   - Detect WP installs under /home
#   - Let user select one or more sites (or all)
#   - Run Maldet and/or ClamAV against the selected paths
#

set -euo pipefail

log()  { echo "[+] $*"; }
warn() { echo "[-] $*"; }
err()  { echo "[!] $*" >&2; }

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    err "This script must be run as root (sudo)."
    exit 1
  fi
}

check_tools() {
  MALDET_AVAILABLE=0
  CLAMAV_AVAILABLE=0

  if command -v maldet >/dev/null 2>&1; then
    MALDET_AVAILABLE=1
  else
    warn "maldet not found; skipping Maldet scan."
  fi

  if command -v clamscan >/dev/null 2>&1; then
    CLAMAV_AVAILABLE=1
  else
    warn "clamscan (ClamAV) not found; skipping ClamAV scan."
  fi

  if (( MALDET_AVAILABLE == 0 && CLAMAV_AVAILABLE == 0 )); then
    err "Neither Maldet nor ClamAV is installed. Nothing to do."
    err "Install with something like:"
    err "  apt-get update && apt-get install -y clamav"
    err "  # Maldet usually from source / vendor installer"
    exit 1
  fi
}

discover_wp_paths() {
  mapfile -t WP_PATHS < <(
    find /home -maxdepth 3 -type f -name "wp-config.php" 2>/dev/null \
      | sed 's#/wp-config.php$##' | sort
  )
}

select_sites() {
  discover_wp_paths

  if [[ ${#WP_PATHS[@]} -eq 0 ]]; then
    warn "No WordPress installations found under /home."
    exit 0
  fi

  echo
  log "Detected WordPress installations and their sizes:"
  local i=1
  for wp in "${WP_PATHS[@]}"; do
    local db domain size
    db=$(grep -E "define\\(\\s*'DB_NAME'" "$wp/wp-config.php" 2>/dev/null | awk -F"'" '{print $4}')
    domain="$(basename "$(dirname "$wp")")"
    size=$(du -sh "$wp" 2>/dev/null | awk '{print $1}')
    echo "  [$i] $domain (DB: ${db:-UNKNOWN}, Path: $wp, Size: ${size:-N/A})"
    ((i++))
  done

  echo
  read -rp "Scan which sites? (e.g. 1 2 5, or A for all): " selection

  SELECTED_WP_PATHS=()

  if [[ "$selection" =~ ^[Aa]$ ]]; then
    SELECTED_WP_PATHS=("${WP_PATHS[@]}")
  else
    for token in $selection; do
      if ! [[ "$token" =~ ^[0-9]+$ ]]; then
        warn "Ignoring invalid token '$token' (not a number)."
        continue
      fi
      if (( token < 1 || token > ${#WP_PATHS[@]} )); then
        warn "Ignoring out-of-range index '$token'."
        continue
      fi
      SELECTED_WP_PATHS+=("${WP_PATHS[token-1]}")
    done
  fi

  if [[ ${#SELECTED_WP_PATHS[@]} -eq 0 ]]; then
    err "No valid sites selected; nothing to scan."
    exit 1
  fi

  echo
  log "You selected ${#SELECTED_WP_PATHS[@]} site(s) to scan:"
  for wp in "${SELECTED_WP_PATHS[@]}"; do
    local domain
    domain="$(basename "$(dirname "$wp")")"
    echo "  - $domain ($wp)"
  done
}

run_scans() {
  for wp in "${SELECTED_WP_PATHS[@]}"; do
    local domain
    domain="$(basename "$(dirname "$wp")")"

    echo
    log "=== Scanning $domain ($wp) ==="

    if (( MALDET_AVAILABLE == 1 )); then
      echo
      log "Running Maldet scan on $wp ..."
      # -a  = scan path
      # we don't set --clean automatically; just report
      if ! maldet -a "$wp"; then
        warn "Maldet scan reported errors for $domain (check maldet logs)."
      fi
    fi

    if (( CLAMAV_AVAILABLE == 1 )); then
      echo
      log "Running ClamAV scan on $wp ..."
      # -r = recursive, -i = only print infected files
      if ! clamscan -ri "$wp"; then
        warn "ClamAV scan reported issues for $domain (above)."
      fi
    fi

    echo
    log "Finished scans for $domain."
  done
}

main() {
  require_root
  check_tools
  select_sites
  run_scans

  echo
  log "Malware scans completed for all selected sites."
}

main "$@"
